<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Extrapolador Avanzado</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .input-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input, select, button { width: 100%; padding: 8px; margin-bottom: 10px; }
    button { background: #3498db; color: white; border: none; cursor: pointer; }
    .status-message { padding: 10px; margin: 10px 0; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .warning { background: #fff3cd; color: #856404; }
    .chart-container { height: 400px; margin-top: 20px; }
    .debug-info { font-family: monospace; white-space: pre-wrap; background: #f0f0f0; padding: 10px; margin-top: 10px; }
    .row-range { display: flex; gap: 10px; }
    .row-range > div { flex: 1; }
  </style>
</head>
<body>
<div class="container">
  <h1>Extrapolador Avanzado</h1>
  <div class="input-group">
    <label for="excelFile">Archivo Excel (.xlsx, .xlsm):</label>
    <input type="file" id="excelFile" accept=".xlsx,.xlsm">
  </div>
  <div class="row-range">
    <div class="input-group">
      <label for="startRow">Fila Inicial:</label>
      <input type="number" id="startRow" min="1" value="1">
    </div>
    <div class="input-group">
      <label for="endRow">Fila Final:</label>
      <input type="number" id="endRow" min="1">
    </div>
  </div>
  <button id="loadExcelBtn">Cargar Datos de Excel</button>
  <div id="excelStatus" class="status-message">Esperando archivo Excel</div>
  <div class="debug-info" id="debugContent"></div>
</div>
<script>
  let pyodide = null;
  const excelFileInput = document.getElementById('excelFile');
  const loadExcelBtn = document.getElementById('loadExcelBtn');
  const startRowInput = document.getElementById('startRow');
  const endRowInput = document.getElementById('endRow');
  const excelStatus = document.getElementById('excelStatus');
  const debugInfo = document.getElementById('debugContent');

  async function initializePyodide() {
    pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/" });
    await pyodide.loadPackage(['micropip']);
    await pyodide.runPythonAsync(`import micropip; await micropip.install('openpyxl')`);
    excelStatus.textContent = "Python listo para procesar Excel";
    excelStatus.className = "status-message success";
  }

  async function loadExcelData() {
    const excelFile = excelFileInput.files[0];
    if (!pyodide || !excelFile) return;
    try {
      excelStatus.textContent = "Procesando Excel...";
      excelStatus.className = "status-message warning";
      const startRow = parseInt(startRowInput.value) || 1;
      const endRow = parseInt(endRowInput.value) || 0;
      const arrayBuffer = await excelFile.arrayBuffer();
      const bytes = new Uint8Array(arrayBuffer);
      pyodide.FS.writeFile(excelFile.name, bytes);

      const result = await pyodide.runPythonAsync(`
        import traceback, json, re
        from openpyxl import load_workbook
        from openpyxl.utils import get_column_letter
        from js import startRow, endRow

        def process_excel():
          output = {"sheets": [], "excel_data": {}, "debug_info": ""}
          try:
            start = int(startRow)
            end = int(endRow)
            wb = load_workbook("${excelFile.name}", data_only=True)
            output["sheets"] = wb.sheetnames
            output["debug_info"] += f"Se encontraron {len(wb.sheetnames)} hojas\n"
            for sheet in wb.sheetnames:
              ws = wb[sheet]
              min_row = start
              max_row = ws.max_row if end == 0 else min(end, ws.max_row)
              output["debug_info"] += f"\nHoja: {sheet} (Filas: {min_row}-{max_row})\n"
              for col_idx in range(1, ws.max_column + 1):
                col_letter = get_column_letter(col_idx)
                col_values = []
                for row_idx in range(min_row, max_row + 1):
                  cell = ws.cell(row=row_idx, column=col_idx)
                  if cell.value is None: continue
                  try:
                    val = str(cell.value).strip().replace("\u00b0C", "").replace(" ", "")
                    val = re.sub(r'[^\\d.,-]', '', val).replace(",", ".")
                    num = float(val)
                    col_values.append(num)
                  except:
                    output["debug_info"] += f"  Celda {col_letter}{row_idx} invÃ¡lida: '{cell.value}'\n"
                if col_values:
                  output["excel_data"].setdefault(sheet, {})[col_letter] = col_values
                  output["debug_info"] += f"  Col {col_letter}: {len(col_values)} valores\n"
            output["debug_info"] += "\nProcesamiento completado"
          except Exception as e:
            output["debug_info"] += f"\nERROR: {str(e)}\n" + traceback.format_exc()
          return json.dumps(output)

        process_excel()
      `, { startRow, endRow });

      const parsed = JSON.parse(result);
      debugInfo.textContent = parsed.debug_info;
      excelStatus.textContent = "Archivo procesado";
      excelStatus.className = "status-message success";
    } catch (err) {
      excelStatus.textContent = "Error: " + err.message;
      excelStatus.className = "status-message error";
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    initializePyodide();
    loadExcelBtn.addEventListener('click', loadExcelData);
  });
</script>
</body>
</html>
