<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Extrapolador Avanzado</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .input-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input, select, button { width: 100%; padding: 8px; margin-bottom: 10px; }
    button { background: #3498db; color: white; border: none; cursor: pointer; }
    .status-message { padding: 10px; margin: 10px 0; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .warning { background: #fff3cd; color: #856404; }
    .chart-container { height: 400px; margin-top: 20px; }
    .debug-info { font-family: monospace; white-space: pre-wrap; background: #f0f0f0; padding: 10px; margin-top: 10px; }
    .row-range { display: flex; gap: 10px; }
    .row-range > div { flex: 1; }
  </style>
</head>
<body>
<div class="container">
  <h1>Extrapolador Avanzado</h1>

  <div class="tab-container">
    <button id="excelTab" class="tab active">Excel</button>
    <button id="csvTab" class="tab">CSV</button>
  </div>

  <!-- Excel Section -->
  <div id="excelSection" class="section">
    <div class="input-group">
      <label for="excelFile">Archivo Excel (.xlsx, .xlsm):</label>
      <input type="file" id="excelFile" accept=".xlsx,.xlsm">
    </div>

    <div class="row-range">
      <div class="input-group">
        <label for="startRow">Fila Inicial:</label>
        <input type="number" id="startRow" min="1" value="1">
      </div>
      <div class="input-group">
        <label for="endRow">Fila Final:</label>
        <input type="number" id="endRow" min="1">
      </div>
    </div>

    <div class="sheet-selection">
      <div class="input-group">
        <label for="sheetSelect">Hoja:</label>
        <select id="sheetSelect">
          <option value="">-- Seleccionar hoja --</option>
        </select>
      </div>
      <div class="input-group">
        <label for="columnSelect">Columna:</label>
        <select id="columnSelect">
          <option value="">-- Seleccionar columna --</option>
        </select>
      </div>
    </div>

    <button id="loadExcelBtn">Cargar Datos de Excel</button>
    <div id="excelStatus" class="status-message">Esperando archivo Excel</div>
  </div>

  <!-- CSV Section -->
  <div id="csvSection" class="section" style="display:none;">
    <div class="input-group">
      <label for="csvFile">Archivo CSV:</label>
      <input type="file" id="csvFile" accept=".csv">
    </div>
    <button id="loadCsvBtn">Cargar Datos CSV</button>
    <div id="csvStatus" class="status-message">Esperando archivo CSV</div>
  </div>

  <!-- Temperatura -->
  <div class="input-group">
    <label for="minTemp">Temperatura Mínima:</label>
    <input type="text" id="minTemp" placeholder="Ej: 15,5">
  </div>
  <div class="input-group">
    <label for="maxTemp">Temperatura Máxima:</label>
    <input type="text" id="maxTemp" placeholder="Ej: 32,0">
  </div>

  <!-- Botones -->
  <button id="downloadCsvBtn">Descargar CSV</button>
  <button id="downloadExcelBtn">Descargar Excel Modificado</button>
  <div id="downloadStatus" class="status-message"></div>

  <!-- Gráfico -->
  <div class="chart-container">
    <canvas id="temperatureChart"></canvas>
  </div>

  <!-- Debug -->
  <div class="debug-info" id="debugContent"></div>
</div>

<script>
  let pyodide = null;
  let originalData = [], minOriginal = 0, maxOriginal = 0, minTemp = 0, maxTemp = 0;
  let temperatureChart = null, excelFile = null, selectedSheet = "", selectedColumn = "";
  const excelFileInput = document.getElementById('excelFile');
  const loadExcelBtn = document.getElementById('loadExcelBtn');
  const sheetSelect = document.getElementById('sheetSelect');
  const columnSelect = document.getElementById('columnSelect');
  const minTempInput = document.getElementById('minTemp');
  const maxTempInput = document.getElementById('maxTemp');
  const excelStatus = document.getElementById('excelStatus');
  const debugInfo = document.getElementById('debugContent');
  const startRowInput = document.getElementById('startRow');
  const endRowInput = document.getElementById('endRow');

  async function initializePyodide() {
    pyodide = await loadPyodide({
      indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"
    });
    await pyodide.loadPackage(['micropip']);
    await pyodide.runPythonAsync(`
      import micropip
      await micropip.install('openpyxl')
    `);
    excelStatus.textContent = "Python listo para procesar Excel";
    excelStatus.className = "status-message success";
  }

  async function loadExcelData() {
    if (!pyodide || !excelFile) return;
    try {
      excelStatus.textContent = "Procesando Excel...";
      excelStatus.className = "status-message warning";
      const startRow = parseInt(startRowInput.value) || 1;
      const endRow = parseInt(endRowInput.value) || 0;
      const arrayBuffer = await excelFile.arrayBuffer();
      const bytes = new Uint8Array(arrayBuffer);
      pyodide.FS.writeFile(excelFile.name, bytes);

      const result = await pyodide.runPythonAsync(`
        import traceback, json, re
        from openpyxl import load_workbook
        from openpyxl.utils import get_column_letter
        from js import startRow, endRow

        def process_excel():
            output = {"sheets": [], "excel_data": {}, "debug_info": ""}
            try:
                wb = load_workbook("${excelFile.name}", data_only=True)
                output["sheets"] = wb.sheetnames
                output["debug_info"] += f"Se encontraron {len(wb.sheetnames)} hojas\\n"
                for sheet in wb.sheetnames:
                    ws = wb[sheet]
                    min_row = startRow
                    max_row = ws.max_row if endRow == 0 else min(endRow, ws.max_row)
                    output["debug_info"] += f"\\nHoja: {sheet} (Filas: {min_row}-{max_row})\\n"
                    sheet_data = {}
                    for col_idx in range(1, ws.max_column + 1):
                        col_letter = get_column_letter(col_idx)
                        col_values = []
                        for row_idx in range(min_row, max_row + 1):
                            cell = ws.cell(row=row_idx, column=col_idx)
                            if cell.value is None: continue
                            try:
                                val = str(cell.value).strip().replace("°C", "").replace(" ", "")
                                val = re.sub(r'[^\\d.,-]', '', val).replace(",", ".")
                                num = float(val)
                                col_values.append(num)
                            except:
                                output["debug_info"] += f"  Celda {col_letter}{row_idx} inválida: '{cell.value}'\\n"
                        if col_values:
                            sheet_data[col_letter] = col_values
                            output["debug_info"] += f"  Col {col_letter}: {len(col_values)} valores\\n"
                    if sheet_data:
                        output["excel_data"][sheet] = sheet_data
                output["debug_info"] += "\\nProcesamiento completado"
            except Exception as e:
                output["debug_info"] += f"\\nERROR: {str(e)}\\n" + traceback.format_exc()
            return json.dumps(output)

        process_excel()
      `, { startRow, endRow });

      const parsed = JSON.parse(result);
      debugInfo.textContent = parsed.debug_info;

      if (!parsed.excel_data || Object.keys(parsed.excel_data).length === 0) {
        excelStatus.textContent = "No se encontraron datos válidos";
        excelStatus.className = "status-message error";
        return;
      }

      sheetSelect.innerHTML = '<option value="">-- Seleccionar hoja --</option>';
      parsed.sheets.forEach(sheet => {
        const opt = document.createElement("option");
        opt.value = sheet;
        opt.textContent = sheet;
        sheetSelect.appendChild(opt);
      });

      sheetSelect.onchange = () => {
        selectedSheet = sheetSelect.value;
        if (!selectedSheet) return;
        columnSelect.innerHTML = '<option value="">-- Seleccionar columna --</option>';
        const sheetData = parsed.excel_data[selectedSheet];
        for (const col in sheetData) {
          const opt = document.createElement("option");
          opt.value = col;
          opt.textContent = col;
          columnSelect.appendChild(opt);
        }
      };

      columnSelect.onchange = () => {
        selectedColumn = columnSelect.value;
        if (!selectedSheet || !selectedColumn) return;
        originalData = parsed.excel_data[selectedSheet][selectedColumn];
        if (originalData.length) {
          minOriginal = Math.min(...originalData);
          maxOriginal = Math.max(...originalData);
          minTemp = minOriginal;
          maxTemp = maxOriginal;
          minTempInput.value = minTemp.toFixed(1);
          maxTempInput.value = maxTemp.toFixed(1);
          updateChart();
          excelStatus.textContent = `Datos cargados: ${originalData.length} valores`;
          excelStatus.className = "status-message success";
        }
      };

      if (parsed.sheets.length > 0) {
        sheetSelect.value = parsed.sheets[0];
        sheetSelect.dispatchEvent(new Event('change'));
      }
    } catch (err) {
      excelStatus.textContent = "Error: " + err.message;
      excelStatus.className = "status-message error";
    }
  }

  function updateChart() {
    if (!originalData.length) return;
    const labels = originalData.map((_, i) => i + 1);
    const extrapolated = extrapolateData();
    temperatureChart.data.labels = labels;
    temperatureChart.data.datasets[0].data = originalData;
    temperatureChart.data.datasets[1].data = extrapolated;
    temperatureChart.update();
  }

  function extrapolateData() {
    minTemp = parseFloat(minTempInput.value) || minOriginal;
    maxTemp = parseFloat(maxTempInput.value) || maxOriginal;
    const originalRange = maxOriginal - minOriginal;
    const newRange = maxTemp - minTemp;
    return originalData.map(v => minTemp + ((v - minOriginal) / originalRange) * newRange);
  }

  function initChart() {
    const ctx = document.getElementById('temperatureChart').getContext('2d');
    temperatureChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          { label: 'Original', data: [], borderColor: '#3498db', borderWidth: 2, fill: false },
          { label: 'Extrapolado', data: [], borderColor: '#e74c3c', borderWidth: 2, fill: false }
        ]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    initializePyodide();
    initChart();
    loadExcelBtn.addEventListener('click', () => {
      excelFile = excelFileInput.files[0];
      if (excelFile) loadExcelData();
    });
  });
</script>
</body>
</html>
